# COMMON ARGS
ARG ENABLE_BYTECODE=on
ARG ENABLE_CACHE=off

# BUILD ARGS
ARG DISABLE_PIP_VERSION_CHECK=on
ARG PIP_TIMEOUT=100

# RELEASE ARGS
ARG ENABLE_BUFFERED=on


FROM python:3.8-alpine AS build
ARG ENABLE_BYTECODE
ARG ENABLE_CACHE
ARG TIMEOUT

ENV PYTHONDONTWRITEBYTECODE=$ENABLE_BYTECODE \
    PIP_NO_CACHE_DIR=$ENABLE_CACHE \
    PIP_DEFAULT_TIMEOUT=$PIP_TIMEOUT

WORKDIR /app
COPY .. /app
RUN pip wheel --no-input . -w dist


FROM python:3.8-alpine

ARG ENABLE_BUFFERED
ARG ENABLE_BYTECODE
ARG ENABLE_CACHE

ENV PYTHONUNBUFFERED=$ENABLE_BUFFERED \
    PYTHONDONTWRITEBYTECODE=$ENABLE_BYTECODE \
    PIP_NO_CACHE_DIR=$ENABLE_CACHE

WORKDIR /app
COPY --from=build /app/dist /app
RUN pip install --no-input * \
    && rm -f ./*
EXPOSE 8000

ENTRYPOINT ["uvicorn", "{{ cookiecutter.app_name }}.main:app", "--host=0.0.0.0"]